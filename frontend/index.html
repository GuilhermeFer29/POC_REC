<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POC Receitas - Teste</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">
            <i class="fas fa-utensils mr-2"></i>POC Receitas - Painel de Teste
        </h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- RAG Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-database mr-2"></i>RAG - Base de Conhecimento
                </h2>

                <!-- Tabs -->
                <div class="flex border-b mb-4">
                    <button onclick="showRagTab('receitas')" id="tab-receitas" class="px-4 py-2 border-b-2 border-blue-500 text-blue-500 font-medium">Receitas</button>
                    <button onclick="showRagTab('fotografia')" id="tab-fotografia" class="px-4 py-2 text-gray-500 hover:text-gray-700">Fotografia</button>
                </div>

                <!-- Add Content -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Conte√∫do</label>
                    <input type="text" id="rag-name" class="w-full border rounded-md px-3 py-2" placeholder="Ex: Livro de Receitas Brasileiras">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Conte√∫do (texto ou URL)</label>
                    <textarea id="rag-content" rows="4" class="w-full border rounded-md px-3 py-2" placeholder="Cole o texto ou URL aqui..."></textarea>
                </div>

                <div class="flex gap-2 mb-6">
                    <button onclick="addRagContent()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                        <i class="fas fa-plus mr-1"></i>Adicionar Texto
                    </button>
                    <button onclick="addRagUrl()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                        <i class="fas fa-link mr-1"></i>Adicionar URL
                    </button>
                </div>

                <!-- Upload PDF/Arquivo RAG -->
                <div class="border-t pt-4 mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Upload Arquivo (PDF, TXT)</label>
                    <div class="flex gap-2">
                        <input type="file" id="rag-file" accept=".pdf,.txt,.md" class="flex-1 border rounded-md px-2 py-1 text-sm">
                        <button onclick="uploadRagFile()" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600">
                            <i class="fas fa-file-upload mr-1"></i>Upload
                        </button>
                    </div>
                </div>

                <!-- Search -->
                <div class="border-t pt-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Buscar no RAG</label>
                    <div class="flex gap-2">
                        <input type="text" id="rag-search" class="flex-1 border rounded-md px-3 py-2" placeholder="Digite sua busca...">
                        <button onclick="searchRag()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>

                <div id="rag-results" class="mt-4 text-sm text-gray-600"></div>
            </div>

            <!-- Produtos Section -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-box mr-2"></i>Produtos
                </h2>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Produto</label>
                    <input type="text" id="produto-nome" class="w-full border rounded-md px-3 py-2" placeholder="Ex: Leite Condensado">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                    <input type="text" id="produto-tipo" class="w-full border rounded-md px-3 py-2" placeholder="Ex: Latic√≠nio">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o</label>
                    <textarea id="produto-descricao" rows="2" class="w-full border rounded-md px-3 py-2" placeholder="Descri√ß√£o do produto..."></textarea>
                </div>

                <button onclick="criarProduto()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 mb-4">
                    <i class="fas fa-plus mr-1"></i>Criar Produto
                </button>

                <div class="border-t pt-4 mb-4">
                    <h3 class="font-medium text-gray-700 mb-2">Upload Imagem do Produto</h3>
                    <div class="flex gap-2 items-end">
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600 mb-1">ID do Produto</label>
                            <input type="number" id="upload-produto-id" class="w-full border rounded-md px-3 py-2" placeholder="ID">
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm text-gray-600 mb-1">Imagem</label>
                            <input type="file" id="upload-produto-file" accept="image/*" class="w-full border rounded-md px-2 py-1 text-sm">
                        </div>
                        <button onclick="uploadImagemProduto()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                            <i class="fas fa-upload"></i>
                        </button>
                    </div>
                </div>

                <div class="border-t pt-4">
                    <h3 class="font-medium text-gray-700 mb-2">Produtos Cadastrados</h3>
                    <button onclick="listarProdutos()" class="text-blue-500 hover:underline text-sm mb-2">
                        <i class="fas fa-sync mr-1"></i>Atualizar Lista
                    </button>
                    <div id="produtos-lista" class="text-sm text-gray-600 max-h-40 overflow-y-auto"></div>
                </div>
            </div>

            <!-- Receitas Section -->
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-book-open mr-2"></i>Gerar Receita
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ID do Produto</label>
                        <input type="number" id="receita-produto-id" class="w-full border rounded-md px-3 py-2" placeholder="ID do produto">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Descri√ß√£o Adicional (opcional)</label>
                        <input type="text" id="receita-descricao" class="w-full border rounded-md px-3 py-2" placeholder="Ex: Receita para sobremesa de festa">
                    </div>
                </div>

                <button onclick="gerarReceita()" class="bg-orange-500 text-white px-6 py-2 rounded-md hover:bg-orange-600 mb-4">
                    <i class="fas fa-magic mr-1"></i>Gerar Receita com Agentes
                </button>

                <div class="border-t pt-4">
                    <h3 class="font-medium text-gray-700 mb-2">Consultar Receita</h3>
                    <div class="flex gap-2 mb-4">
                        <input type="number" id="receita-id" class="border rounded-md px-3 py-2 w-32" placeholder="ID">
                        <button onclick="consultarReceita()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                            <i class="fas fa-eye mr-1"></i>Ver Receita
                        </button>
                        <button onclick="downloadReceitaHTML()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                            <i class="fas fa-download mr-1"></i>Download HTML
                        </button>
                    </div>
                </div>

                <div id="receita-resultado" class="mt-4 p-4 bg-gray-50 rounded-md hidden">
                    <h3 class="font-semibold text-gray-700 mb-2">Resultado</h3>
                    <div id="receita-content"></div>
                </div>
            </div>

            <!-- Enriquecimento Section -->
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-magic mr-2"></i>Enriquecimento Autom√°tico
                </h2>

                <!-- BOT√ÉO PRINCIPAL - ENRIQUECER TUDO -->
                <div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg p-6 mb-6 text-white">
                    <h3 class="text-lg font-bold mb-2">üöÄ Enriquecimento Completo</h3>
                    <p class="text-sm opacity-90 mb-4">
                        Um clique para fazer tudo automaticamente:
                        importar ~500 ingredientes, buscar dados nutricionais, baixar imagens e popular o RAG com receitas.
                    </p>
                    <button onclick="enriquecerTudo()" id="btn-enriquecer-tudo" class="bg-white text-purple-600 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition-all">
                        <i class="fas fa-rocket mr-2"></i>ENRIQUECER TUDO AUTOMATICAMENTE
                    </button>
                    
                    <!-- Barra de Progresso -->
                    <div id="enrich-progress" class="mt-4 hidden">
                        <div class="flex items-center gap-2 mb-3">
                            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white"></div>
                            <span id="enrich-progress-text" class="font-medium">Iniciando...</span>
                        </div>
                        
                        <!-- Barra de progresso geral -->
                        <div class="w-full bg-white/30 rounded-full h-3 mb-4">
                            <div id="progress-bar" class="bg-white h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        
                        <!-- Etapas -->
                        <div class="grid grid-cols-4 gap-2 text-xs">
                            <div id="step-1" class="text-center opacity-50">
                                <div class="w-8 h-8 mx-auto rounded-full bg-white/30 flex items-center justify-center mb-1">
                                    <i class="fas fa-download"></i>
                                </div>
                                <span>Importar</span>
                            </div>
                            <div id="step-2" class="text-center opacity-50">
                                <div class="w-8 h-8 mx-auto rounded-full bg-white/30 flex items-center justify-center mb-1">
                                    <i class="fas fa-flask"></i>
                                </div>
                                <span>Nutri√ß√£o</span>
                            </div>
                            <div id="step-3" class="text-center opacity-50">
                                <div class="w-8 h-8 mx-auto rounded-full bg-white/30 flex items-center justify-center mb-1">
                                    <i class="fas fa-leaf"></i>
                                </div>
                                <span>RAG Ing.</span>
                            </div>
                            <div id="step-4" class="text-center opacity-50">
                                <div class="w-8 h-8 mx-auto rounded-full bg-white/30 flex items-center justify-center mb-1">
                                    <i class="fas fa-utensils"></i>
                                </div>
                                <span>Receitas</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Enriquecer Ingrediente -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-medium text-gray-700 mb-2">Enriquecer Ingrediente Individual</h3>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="enrich-ing-nome" class="flex-1 border rounded-md px-3 py-2" placeholder="Nome do ingrediente (ingl√™s)">
                            <button onclick="enriquecerIngrediente()" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500">Busca dados no USDA, Open Food Facts e TheMealDB</p>
                    </div>

                    <!-- Status -->
                    <div class="border rounded-lg p-4">
                        <h3 class="font-medium text-gray-700 mb-2">Status do Banco</h3>
                        <button onclick="statusEnriquecimento()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 w-full mb-2">
                            <i class="fas fa-chart-bar mr-1"></i>Atualizar Status
                        </button>
                        <div id="enrich-status" class="text-sm"></div>
                    </div>
                </div>

                <details class="mt-4 border rounded-lg">
                    <summary class="p-3 cursor-pointer font-medium text-gray-700 hover:bg-gray-50">
                        <i class="fas fa-cog mr-2"></i>Op√ß√µes Avan√ßadas
                    </summary>
                    <div class="p-4 border-t grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Importar TheMealDB -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-2">Importar Ingredientes TheMealDB</h3>
                            <button onclick="importarTheMealDB()" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 w-full">
                                <i class="fas fa-download mr-1"></i>Importar Todos
                            </button>
                        </div>

                        <!-- Popular RAG com Receitas -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-2">Popular RAG com Receitas</h3>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="rag-categoria" class="flex-1 border rounded-md px-3 py-2" placeholder="Categoria (ex: Dessert)">
                                <input type="number" id="rag-limite" class="w-20 border rounded-md px-2 py-2" value="10">
                            </div>
                            <button onclick="popularRAGReceitas()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 w-full">
                                <i class="fas fa-database mr-1"></i>Popular RAG
                            </button>
                        </div>

                        <!-- Popular RAG por Ingrediente -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-2">Receitas por Ingrediente</h3>
                            <div class="flex gap-2 mb-2">
                                <input type="text" id="rag-ingrediente" class="flex-1 border rounded-md px-3 py-2" placeholder="Ex: chicken, beef...">
                                <button onclick="popularRAGPorIngrediente()" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Adicionar Ingredientes ao RAG -->
                        <div class="border rounded-lg p-4">
                            <h3 class="font-medium text-gray-700 mb-2">Ingredientes ao RAG</h3>
                            <button onclick="popularRAGIngredientes()" class="bg-teal-500 text-white px-4 py-2 rounded-md hover:bg-teal-600 w-full">
                                <i class="fas fa-leaf mr-1"></i>Adicionar ao RAG
                            </button>
                        </div>
                    </div>
                </details>
            </div>

            <!-- Logs Section -->
            <div class="bg-white rounded-lg shadow-md p-6 lg:col-span-2">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">
                    <i class="fas fa-terminal mr-2"></i>Logs
                </h2>
                <div id="logs" class="bg-gray-900 text-green-400 p-4 rounded-md font-mono text-sm h-48 overflow-y-auto"></div>
                <button onclick="clearLogs()" class="mt-2 text-sm text-gray-500 hover:text-gray-700">
                    <i class="fas fa-trash mr-1"></i>Limpar Logs
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let currentRagTab = 'receitas';

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            logs.innerHTML += `<div class="${color}">[${time}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        function showRagTab(tab) {
            currentRagTab = tab;
            document.getElementById('tab-receitas').className = tab === 'receitas' 
                ? 'px-4 py-2 border-b-2 border-blue-500 text-blue-500 font-medium'
                : 'px-4 py-2 text-gray-500 hover:text-gray-700';
            document.getElementById('tab-fotografia').className = tab === 'fotografia'
                ? 'px-4 py-2 border-b-2 border-blue-500 text-blue-500 font-medium'
                : 'px-4 py-2 text-gray-500 hover:text-gray-700';
            log(`Tab alterada para: ${tab}`);
        }

        async function addRagContent() {
            const name = document.getElementById('rag-name').value;
            const content = document.getElementById('rag-content').value;
            if (!name || !content) {
                log('Preencha nome e conte√∫do', 'error');
                return;
            }
            try {
                log(`Adicionando conte√∫do "${name}" ao RAG ${currentRagTab}...`);
                const res = await fetch(`${API_URL}/rag/${currentRagTab}/content`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, content })
                });
                const data = await res.json();
                log(data.message || JSON.stringify(data), 'success');
                
                // Limpar campos ap√≥s adicionar
                document.getElementById('rag-name').value = '';
                document.getElementById('rag-content').value = '';
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function addRagUrl() {
            const name = document.getElementById('rag-name').value;
            const url = document.getElementById('rag-content').value;
            if (!name || !url) {
                log('Preencha nome e URL', 'error');
                return;
            }
            try {
                log(`Adicionando URL "${name}" ao RAG ${currentRagTab}...`);
                const res = await fetch(`${API_URL}/rag/${currentRagTab}/url`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, url })
                });
                const data = await res.json();
                log(data.message || JSON.stringify(data), 'success');
                
                // Limpar campos ap√≥s adicionar
                document.getElementById('rag-name').value = '';
                document.getElementById('rag-content').value = '';
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function searchRag() {
            const query = document.getElementById('rag-search').value;
            if (!query) {
                log('Digite uma busca', 'error');
                return;
            }
            try {
                log(`Buscando "${query}" no RAG ${currentRagTab}...`);
                const res = await fetch(`${API_URL}/rag/${currentRagTab}/search`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, num_documents: 5 })
                });
                const data = await res.json();
                const resultsDiv = document.getElementById('rag-results');
                if (data.results && data.results.length > 0) {
                    resultsDiv.innerHTML = `<strong>Resultados:</strong><ul class="list-disc pl-5 mt-2">${data.results.map(r => `<li>${JSON.stringify(r).substring(0, 200)}...</li>`).join('')}</ul>`;
                    log(`Encontrados ${data.results.length} resultados`, 'success');
                } else {
                    resultsDiv.innerHTML = '<em>Nenhum resultado encontrado</em>';
                    log('Nenhum resultado encontrado');
                }
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function criarProduto() {
            const nome = document.getElementById('produto-nome').value;
            const tipo = document.getElementById('produto-tipo').value;
            const descricao = document.getElementById('produto-descricao').value;
            if (!nome) {
                log('Preencha o nome do produto', 'error');
                return;
            }
            try {
                log(`Criando produto "${nome}"...`);
                const res = await fetch(`${API_URL}/produtos`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nome_produto: nome, 
                        tipo_produto: tipo || null, 
                        descricao: descricao || null 
                    })
                });
                const data = await res.json();
                log(`Produto criado com ID: ${data.id}`, 'success');
                
                // Limpar campos ap√≥s criar
                document.getElementById('produto-nome').value = '';
                document.getElementById('produto-tipo').value = '';
                document.getElementById('produto-descricao').value = '';
                
                // Preencher ID automaticamente no campo de upload
                document.getElementById('upload-produto-id').value = data.id;
                
                // Preencher ID automaticamente no campo de gerar receita
                document.getElementById('receita-produto-id').value = data.id;
                
                listarProdutos();
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function listarProdutos() {
            try {
                log('Listando produtos...');
                const res = await fetch(`${API_URL}/produtos`);
                const data = await res.json();
                const lista = document.getElementById('produtos-lista');
                if (data.length > 0) {
                    lista.innerHTML = data.map(p => `
                        <div class="p-2 border-b flex items-center gap-2">
                            ${p.imagem ? `<img src="${API_URL}/${p.imagem}" class="w-10 h-10 object-cover rounded" onerror="this.style.display='none'">` : '<div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>'}
                            <div class="flex-1">
                                <strong>ID ${p.id}:</strong> ${p.nome}
                                <span class="text-xs text-gray-500">(${p.tipo || 'sem tipo'})</span>
                            </div>
                            <button onclick="selecionarProduto(${p.id})" class="text-blue-500 hover:text-blue-700 text-xs">
                                <i class="fas fa-check"></i> Usar
                            </button>
                        </div>
                    `).join('');
                    log(`${data.length} produtos encontrados`, 'success');
                } else {
                    lista.innerHTML = '<em>Nenhum produto cadastrado</em>';
                    log('Nenhum produto cadastrado');
                }
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }
        
        function selecionarProduto(id) {
            document.getElementById('upload-produto-id').value = id;
            document.getElementById('receita-produto-id').value = id;
            log(`Produto ID ${id} selecionado`, 'success');
        }

        async function gerarReceita() {
            const idProduto = document.getElementById('receita-produto-id').value;
            const descricao = document.getElementById('receita-descricao').value;
            if (!idProduto) {
                log('Informe o ID do produto', 'error');
                return;
            }
            try {
                log(`Gerando receita para produto ID ${idProduto}...`);
                log('Isso pode demorar alguns minutos (Chef ‚Üí Fot√≥grafo ‚Üí Diagramador)');
                const res = await fetch(`${API_URL}/receitas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id_produto: parseInt(idProduto), 
                        descricao_cliente: descricao || null 
                    })
                });
                const data = await res.json();
                log(`Receita criada com ID: ${data.id}, Status: ${data.status}`, 'success');
                document.getElementById('receita-id').value = data.id;
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function consultarReceita() {
            const id = document.getElementById('receita-id').value;
            if (!id) {
                log('Informe o ID da receita', 'error');
                return;
            }
            try {
                log(`Consultando receita ID ${id}...`);
                const res = await fetch(`${API_URL}/receitas/${id}`);
                if (!res.ok) {
                    log('Receita n√£o encontrada', 'error');
                    return;
                }
                const data = await res.json();
                const resultDiv = document.getElementById('receita-resultado');
                const contentDiv = document.getElementById('receita-content');
                resultDiv.classList.remove('hidden');
                
                let html = `<p><strong>Status:</strong> <span class="px-2 py-1 rounded ${data.status === 'done' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${data.status}</span></p>`;
                
                if (data.json_ingredientes) {
                    html += `<p class="mt-2"><strong>Ingredientes:</strong></p><pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">${JSON.stringify(data.json_ingredientes, null, 2)}</pre>`;
                }
                if (data.json_modo_preparo) {
                    html += `<p class="mt-2"><strong>Modo de Preparo:</strong></p><pre class="bg-gray-100 p-2 rounded text-xs overflow-x-auto">${JSON.stringify(data.json_modo_preparo, null, 2)}</pre>`;
                }
                if (data.content_html) {
                    html += `<p class="mt-2"><strong>HTML Gerado:</strong></p><div class="border p-2 rounded mt-1">${data.content_html}</div>`;
                }
                
                contentDiv.innerHTML = html;
                log(`Receita ${id} carregada - Status: ${data.status}`, 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function downloadReceitaHTML() {
            const id = document.getElementById('receita-id').value;
            if (!id) {
                log('Informe o ID da receita para download', 'error');
                return;
            }
            try {
                log(`Baixando HTML da receita ${id} com imagens embutidas...`);
                
                // Usar o endpoint que retorna HTML com imagens em base64
                const downloadUrl = `${API_URL}/receitas/${id}/download`;
                
                // Abrir em nova aba para download (o endpoint retorna com Content-Disposition: attachment)
                window.open(downloadUrl, '_blank');
                
                log(`HTML da receita ${id} baixado com sucesso!`, 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function uploadImagemProduto() {
            const produtoId = document.getElementById('upload-produto-id').value;
            const fileInput = document.getElementById('upload-produto-file');
            if (!produtoId || !fileInput.files[0]) {
                log('Informe ID do produto e selecione uma imagem', 'error');
                return;
            }
            try {
                log(`Fazendo upload da imagem do produto ${produtoId}...`);
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                const res = await fetch(`${API_URL}/upload/produto/${produtoId}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                log(`Imagem salva: ${data.path}`, 'success');
                
                // Limpar campo de arquivo ap√≥s upload
                fileInput.value = '';
                
                // Atualizar lista de produtos para mostrar a imagem
                listarProdutos();
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function uploadRagFile() {
            const fileInput = document.getElementById('rag-file');
            if (!fileInput.files[0]) {
                log('Selecione um arquivo', 'error');
                return;
            }
            try {
                log(`Fazendo upload do arquivo para RAG ${currentRagTab}...`);
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                const res = await fetch(`${API_URL}/upload/rag/${currentRagTab}`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                log(`Arquivo salvo: ${data.path}`, 'success');
                log('Agora adicione o conte√∫do ao RAG via texto ou URL do arquivo local');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function listarArquivos(tipo) {
            try {
                const res = await fetch(`${API_URL}/upload/listar/${tipo}`);
                const data = await res.json();
                log(`${data.arquivos.length} arquivos em ${tipo}`, 'success');
                return data.arquivos;
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
                return [];
            }
        }

        // Enriquecimento
        function updateProgress(step, percent, text) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('enrich-progress-text');
            
            progressBar.style.width = percent + '%';
            progressText.textContent = text;
            
            // Atualizar √≠cones das etapas
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                const iconDiv = stepEl.querySelector('div');
                if (i < step) {
                    stepEl.classList.remove('opacity-50');
                    iconDiv.classList.remove('bg-white/30');
                    iconDiv.classList.add('bg-green-400');
                    iconDiv.innerHTML = '<i class="fas fa-check"></i>';
                } else if (i === step) {
                    stepEl.classList.remove('opacity-50');
                    iconDiv.classList.add('animate-pulse');
                } else {
                    stepEl.classList.add('opacity-50');
                }
            }
        }

        function resetProgress() {
            const steps = ['download', 'flask', 'leaf', 'utensils'];
            for (let i = 1; i <= 4; i++) {
                const stepEl = document.getElementById(`step-${i}`);
                const iconDiv = stepEl.querySelector('div');
                stepEl.classList.add('opacity-50');
                iconDiv.classList.remove('bg-green-400', 'animate-pulse');
                iconDiv.classList.add('bg-white/30');
                iconDiv.innerHTML = `<i class="fas fa-${steps[i-1]}"></i>`;
            }
            document.getElementById('progress-bar').style.width = '0%';
        }

        async function enriquecerTudo() {
            const btn = document.getElementById('btn-enriquecer-tudo');
            const progress = document.getElementById('enrich-progress');
            
            btn.disabled = true;
            btn.classList.add('opacity-50');
            progress.classList.remove('hidden');
            resetProgress();
            
            try {
                log('üöÄ Iniciando enriquecimento completo...');
                
                // Etapa 1: Importar ingredientes
                updateProgress(1, 10, 'Etapa 1/4: Importando ingredientes do TheMealDB...');
                log('üì• Importando ingredientes do TheMealDB...');
                const res1 = await fetch(`${API_URL}/enriquecimento/importar-themealdb`, { method: 'POST' });
                const data1 = await res1.json();
                log(`‚úÖ ${data1.ingredientes_importados || 0} ingredientes importados`, 'success');
                updateProgress(2, 25, 'Etapa 1 conclu√≠da!');
                
                // Etapa 2: Enriquecer com nutri√ß√£o (pular se n√£o tiver USDA key)
                updateProgress(2, 30, 'Etapa 2/4: Buscando dados nutricionais...');
                log('üî¨ Buscando dados nutricionais (USDA, Open Food Facts)...');
                log('‚è≥ Esta etapa pode demorar alguns minutos...');
                // N√£o vamos esperar o background task, apenas iniciar
                await fetch(`${API_URL}/enriquecimento/enriquecer-todos`, { method: 'POST' });
                log('‚úÖ Enriquecimento nutricional iniciado em background', 'success');
                updateProgress(3, 50, 'Etapa 2 iniciada em background');
                
                // Etapa 3: Adicionar ingredientes ao RAG
                updateProgress(3, 55, 'Etapa 3/4: Adicionando ingredientes ao RAG...');
                log('üìö Adicionando ingredientes √† base de conhecimento...');
                const res3 = await fetch(`${API_URL}/enriquecimento/rag/ingredientes`, { method: 'POST' });
                const data3 = await res3.json();
                log(`‚úÖ ${data3.adicionados_ao_rag || 0} ingredientes adicionados ao RAG`, 'success');
                updateProgress(4, 75, 'Etapa 3 conclu√≠da!');
                
                // Etapa 4: Popular RAG com receitas
                updateProgress(4, 80, 'Etapa 4/4: Importando receitas para o RAG...');
                log('üç≥ Importando receitas do TheMealDB para o RAG...');
                const res4 = await fetch(`${API_URL}/enriquecimento/rag/receitas-themealdb`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categorias: null, limite_por_categoria: 5 })
                });
                const data4 = await res4.json();
                log('‚úÖ Receitas sendo importadas em background', 'success');
                
                updateProgress(4, 100, 'üéâ Enriquecimento completo!');
                log('üéâ Enriquecimento completo finalizado!', 'success');
                log('üí° Algumas tarefas continuam em background. Atualize o status em alguns minutos.');
                
                setTimeout(() => statusEnriquecimento(), 2000);
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function enriquecerIngrediente() {
            const nome = document.getElementById('enrich-ing-nome').value;
            if (!nome) {
                log('Digite o nome do ingrediente', 'error');
                return;
            }
            try {
                log(`Enriquecendo ingrediente "${nome}"...`);
                const res = await fetch(`${API_URL}/enriquecimento/ingrediente`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome })
                });
                const data = await res.json();
                if (data.ingrediente) {
                    log(`Ingrediente enriquecido: ID ${data.ingrediente.id}, Cal: ${data.ingrediente.calorias || '-'}`, 'success');
                } else {
                    log(JSON.stringify(data), 'success');
                }
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function importarTheMealDB() {
            try {
                log('Importando ingredientes do TheMealDB...');
                const res = await fetch(`${API_URL}/enriquecimento/importar-themealdb`, {
                    method: 'POST'
                });
                const data = await res.json();
                log(`${data.ingredientes_importados} ingredientes importados`, 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function popularRAGReceitas() {
            const categoria = document.getElementById('rag-categoria').value;
            const limite = parseInt(document.getElementById('rag-limite').value) || 10;
            try {
                log(`Populando RAG com receitas (categoria: ${categoria || 'todas'}, limite: ${limite})...`);
                const res = await fetch(`${API_URL}/enriquecimento/rag/receitas-themealdb`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        categorias: categoria ? [categoria] : null,
                        limite_por_categoria: limite
                    })
                });
                const data = await res.json();
                log(data.message || 'Processamento iniciado em background', 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function popularRAGPorIngrediente() {
            const ingrediente = document.getElementById('rag-ingrediente').value;
            if (!ingrediente) {
                log('Digite o nome do ingrediente', 'error');
                return;
            }
            try {
                log(`Buscando receitas com "${ingrediente}" para RAG...`);
                const res = await fetch(`${API_URL}/enriquecimento/rag/receitas-por-ingrediente`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingrediente, limite: 5 })
                });
                const data = await res.json();
                log(`${data.receitas_adicionadas} receitas adicionadas ao RAG`, 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function popularRAGIngredientes() {
            try {
                log('Adicionando ingredientes ao RAG...');
                const res = await fetch(`${API_URL}/enriquecimento/rag/ingredientes`, {
                    method: 'POST'
                });
                const data = await res.json();
                log(`${data.adicionados_ao_rag} ingredientes adicionados ao RAG`, 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        async function statusEnriquecimento() {
            try {
                const res = await fetch(`${API_URL}/enriquecimento/status`);
                const data = await res.json();
                const statusDiv = document.getElementById('enrich-status');
                statusDiv.innerHTML = `
                    <div class="p-2 bg-blue-50 border border-blue-200 rounded">
                        <strong>Ingredientes:</strong> ${data.ingredientes.total} total |
                        ${data.ingredientes.com_usda} com USDA |
                        ${data.ingredientes.com_openfoodfacts} com OFF |
                        ${data.ingredientes.com_dados_nutricionais} com nutri√ß√£o
                    </div>
                `;
                log('Status atualizado', 'success');
            } catch (e) {
                log(`Erro: ${e.message}`, 'error');
            }
        }

        // Init
        log('Frontend de teste iniciado');
        log('Configure a API_URL se necess√°rio (padr√£o: http://localhost:8000)');
    </script>
</body>
</html>
